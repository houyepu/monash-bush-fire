<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="usermap.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!--Map access-->
  <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.js'></script>
  <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.1.1/mapbox-gl.css' rel='stylesheet'>

  <style type="text/css">
    #map {
        position: absolute;
        width: 650px;
        height: 650px
    }
    .btn {
            text-decoration: none;
            border: none;
            padding: 1px 1px;
            font-size: 12px;
            background-color: rgb(9, 180, 247);
            color: rgb(3, 24, 2);
            border-radius: 1px;
            /*box-shadow: 7px 6px 28px 1px rgba(0, 0, 0, 0.24);*/
            cursor: pointer;
            outline: none;
            transition: 0.2s all;
            z-index: 10;
        }
        /* Adding transformation when the button is active */
          
        .btn:active {
            background-color: rgb(9, 247, 49);
            transform: scale(0.90);
            /* Scaling button to 0.90 to its original size */
            box-shadow: 3px 2px 22px 1px rgba(4, 7, 51, 0.973);
            /* Lowering the shadow */
        }
    
  </style>
</head>

<body>
  <!-- Uses a transparent header that draws on top of the layout's background -->
  <style>
  #info {
    display: table;
    position: relative;
    margin: 0px auto;
    word-wrap: break-word;
    white-space: pre-wrap;
    padding: 10px;
    border: none;
    border-radius: 3px;
    font-size: 12px;
    text-align: center;
    color: rgb(97, 224, 233);
    background: #fff;
  }
  .demo-layout-transparent {
    background-image: linear-gradient(to bottom right, red, yellow);
  }
  .demo-layout-transparent .mdl-layout__header,
  .demo-layout-transparent .mdl-layout__drawer-button {
    /* This background is dark, so we set text to white. Use 87% black instead if
       your background is light. */
    color: white;
  }
  </style>
  
  <div class="demo-layout-transparent mdl-layout mdl-js-layout">
    <header class="mdl-layout__header mdl-layout__header--transparent">
      <div class="mdl-layout__header-row">
        <!-- Title -->
        <span class="mdl-layout-title">User's Pinpoint page</span>
        <!-- Add spacer, to align navigation to the right -->
        <div class="mdl-layout-spacer"></div>
        <!-- Navigation -->
        <nav class="mdl-navigation">
        <a class="mdl-navigation__link" href="register.html">Hou Yepu</a>
        </nav>
      </div>
    </header>
    <div class="mdl-layout__drawer">
      <span class="mdl-layout-title">Title</span>
      <nav class="mdl-navigation">
        <!--<a class="mdl-navigation__link" href="weather.html">Weather</a>-->
        <a class="mdl-navigation__link" href="map.html">Home</a>
        <a class="mdl-navigation__link" href="signin.html">Login</a>
        <a class="mdl-navigation__link" href="register.html">Register</a>
      </nav>
    </div>
    <main class="mdl-layout__content">
      <!--Weather-->
      <!--Map-->
      <!--<pre id=info> </pre>-->
      <div class="mapdiv" id="map"></div>
      
      <script>

        const _username = 'monash-university'
        const _password = 'CvdYP1GCPxyy'

        const _usernameEncoded = encodeURIComponent(_username)
        const _passwordEncoded = encodeURIComponent(_password)

        var token = null

        const url = `https://pfa.foreca.com`;
        fetch(url + `/authorize/token?user=${_usernameEncoded}&password=${_passwordEncoded}`)
          .then(response => response.json())
          .then(data => {
              token = data.access_token;
              token = encodeURIComponent(token)
              console.log(token)
              getCurrent()
          })
          
          var coordinate = [];
          var colour = [];
          var observation_data = [];
          //var coordinate = ['137.7292133105741,-19.350339784093876','137.7292133105741,-18.350339784093876'];
          
          function getRandomColor() {
            var letters = '0123456789ABCDEF';
            var color = '#';
            for (var i = 0; i < 6; i++) {
           color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
          }
          //trying to get brighter colours only
          function getColor(){ 
            return "hsl(" + 360 * Math.random() + ',' +
             (25 + 70 * Math.random()) + '%,' + 
             (85 + 10 * Math.random()) + '%)'
          }
      
          function getCurrent() {
        //coordinates.id.length
        //coordinates.id[i]
        for (let i = 0; i < coordinate.length; i++) {
          if (i == 0){
            observation_data = [];
          }
          user_coordinates = coordinate[i];
          fetch(url + `/api/v1/observation/latest/${user_coordinates}?token=${token}`)
          .then(response => response.json())
          .then(data => {
          console.log(data)
          observation_data.push(data.observations[0])
          // Put the object into storage
          localStorage.setItem('observation_data', JSON.stringify(observation_data));

          // Retrieve the object from storage
          var retrievedObject = localStorage.getItem('observation_data');

          console.log('retrievedObject: ', JSON.parse(retrievedObject));
          //updateMap(data.observation,i)
          })
        }
        //getCurrent2()
      }

        //https://pfa.foreca.com/api/v1/observation/latest/137.7292133105741,-19.350339784093876?token=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJpc3MiOiJodHRwOlwvXC9wZmEuZm9yZWNhLmNvbVwvYXV0aG9yaXplXC90b2tlbiIsImlhdCI6MTYzMjI3NzIyMCwiZXhwIjoxNjMyMjgwODIwLCJuYmYiOjE2MzIyNzcyMjAsImp0aSI6IjA4YzAzNDU5YjJmMDM4MTciLCJzdWIiOiJtb25hc2gtdW5pdmVyc2l0eSIsImZtdCI6IlhEY09oakM0MCtBTGpsWVR0amJPaUE9PSJ9.jupHPVHT7qnKJ8_3dy0kinoHjKGl5QatK5dI2IlLrJ8
        mapboxgl.accessToken = "pk.eyJ1IjoidGRveTAwMDEiLCJhIjoiY2t0NnhvNzI4MG40dDJ1bzB4dHoyemhqMSJ9.5JRWGF3yYfWhd3SEqa1Xfg";
        let map = new mapboxgl.Map({
          container: 'map',
          center: [133, -28.5], // starting position [lng, lat]
          zoom: 3.4,
          style: 'mapbox://styles/mapbox/satellite-streets-v11'
          });
          colour = [];

          map.on('click', (e) => {
          //document.getElementById('info').innerHTML = JSON.stringify(e.point) +'<br />' + JSON.stringify(e.lngLat.wrap());
          let coords = e.lngLat;
          coordinate.push(coords)
          console.log(coordinate)
          
          localStorage.setItem('coordinates', JSON.stringify(coordinate));
          
          // Retrieve the object from storage
          var retrieved_coords = JSON.parse(localStorage.getItem('coordinates'));

          console.log('retrieved coordinates: ', retrieved_coords);
          this_colour = getRandomColor();
          colour.push(this_colour);
          localStorage.setItem('colour', JSON.stringify(colour));
          var this_colours = JSON.parse(localStorage.getItem('colour'));
          getCurrent()
          for (let i = 0; i < retrieved_coords.length; i++) {
          let new_marker = new mapboxgl.Marker({ "color": this_colours[i] });
          console.log(retrieved_coords[i])
          new_marker.setLngLat(retrieved_coords[i]);
          new_marker.addTo(map);
          //let popup = new mapboxgl.Popup({ offset: 45 });
          /*
          new_marker.bindPopup("Popup content");
          new_marker.on('mouseover', (e) => {
            this.openPopup();
          });
          new_marker.on('mouseout', (e) => {
            this.closePopup();
          });
          */
          // Set popup text to HTML
         // popup.setHTML(desc);
          
          // Attach the popup to the marker
         // new_marker.setPopup(popup)
          // Add the marker to the map
          new_marker.addTo(map);
          // Add the popup to the map
          // popup.addTo(map1);
        }
          });
      </script>
    </main>
  </div>
  
  
</body>
<script src="js/dummy.js"></script>
</script>


<!--Pinpoints-->

<form class="box" method= "POST">
  <h1>Pinpoints<br></h1>
  <div id="container"></div>

  <!--
  <table class="mdl-data-table mdl-js-data-table mdl-shadow--2dp table-responsive" style="border-collapse: collapse; padding: 15px;">
    <thead>
      <tr>
          <th class="mdl-data-table__cell--non-numeric"><h6>coordinates:<script>coordinate[i]</script></h6></th>
          <td><span class="material-icons">thermostat</span></td>
      </thead>
    <tbody id = "weatherTable-origin">
    <tr>
        <td class="mdl-data-table__cell--non-numeric">Temperature</td>
        <td>${data.temperature}&#8451;</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric">Humidity</td>
        <td>${data.relHumidity}%</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric">Wind Speed</td>
        <td>${data.windSpeed} km/h</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric">Wind Gust</td>
        <td>${data.windGust} knots</td>
    </tr>
    <tr>
        <td class="mdl-data-table__cell--non-numeric">UV Index</td>
        <td>${data.uvIndex}</td>
    </tr>
    </tbody>
</table>
-->
<script type="text/javascript" src = "js/marker.js">updateMap(data.observation,i)</script>
</form>
</html>